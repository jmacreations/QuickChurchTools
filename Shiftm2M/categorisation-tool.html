<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shift m2M Categorisation Tool</title>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif; background:#f5f5f5; padding:20px; }
        .container { max-width:1200px; margin:0 auto; background:white; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,.1); }
        .tabs { display:flex; align-items:center; justify-content:space-between; gap:12px; border-bottom:2px solid #e0e0e0; padding:12px 20px; position:sticky; top:0; background:white; z-index:110; }
        /* Tabs Switch */
        .tabs-switch-wrapper { display:inline-grid; grid-template-columns:1fr 1fr 1fr; background:#f5f5f5; padding:4px; border-radius:8px; position:relative; }
        .tabs-switch-wrapper input { display:none; }
        .tab-label { padding:8px 20px; cursor:pointer; text-align:center; z-index:2; font-size:15px; font-weight:500; color:#666; transition:color .3s; }
        .tabs-switch-wrapper input:checked + label { color:#2563eb; }
        .tabs-slider { position:absolute; top:4px; bottom:4px; left:4px; width:calc((100% - 8px) / 3); background:white; border-radius:6px; transition:transform .3s ease; z-index:1; box-shadow:0 1px 2px rgba(0,0,0,.1); }
        #tab-results:checked ~ .tabs-slider { transform:translateX(100%); }
        #tab-help:checked ~ .tabs-slider { transform:translateX(200%); }
        .tabs-right { display:flex; align-items:center; }
        /* Theme Switch */
        .theme-switch-wrapper { display:inline-grid; grid-template-columns:1fr 1fr; background:#f5f5f5; padding:4px; border-radius:8px; position:relative; margin-left:10px; }
        .theme-switch-wrapper input { display:none; }
        .theme-label { padding:6px 12px; cursor:pointer; text-align:center; z-index:2; font-size:14px; font-weight:500; color:#666; transition:color .3s; }
        .theme-switch-wrapper input:checked + label { color:#2563eb; }
        .theme-slider { position:absolute; top:4px; bottom:4px; left:4px; width:calc(50% - 4px); background:white; border-radius:6px; transition:transform .3s ease; z-index:1; box-shadow:0 1px 2px rgba(0,0,0,.1); }
        #theme-dark:checked ~ .theme-slider { transform:translateX(100%); }
        

        .tab-content { display:none;}
        .tab-content.active { display:block; }
        .header { position:sticky; top:67px; z-index:100; background:#ffffffbb; backdrop-filter:saturate(180%) blur(8px); border-bottom:1px solid #e6e6e6; padding:12px 20px; }
        .header-inner { display:grid; grid-template-columns:1fr auto auto; gap:16px; align-items:center; }
        .header-left { display:flex; flex-direction:row; align-items:center; gap:15px; }
        .header-title { font-size:16px; font-weight:600; color:#1f2937; margin-right:5px; }
        .progress-bar { width:400px; height:10px; background:#eee; border-radius:999px; overflow:hidden; position:relative; }
        .progress-fill { height:100%; background:linear-gradient(90deg,#10b981,#22c55e); transition:width .3s ease; }
        .progress-meta { font-size:12px; color:#6b7280; }
        .controls { display:flex; gap:8px; flex-wrap:wrap; }
        .btn { padding:8px 14px; border:none; border-radius:8px; cursor:pointer; font-size:14px; font-weight:500; transition:.3s; }
        .btn-primary { background:#2563eb; color:#fff; }
        .btn-primary:hover { background:#1d4ed8; }
        .btn-danger { background:#ef4444; color:#fff; }
        .btn-danger:hover { background:#dc2626; }
        .btn-secondary { background:#6b7280; color:#fff; }
        .btn-secondary:hover { background:#4b5563; }
        /* Mode Switch */
        .list-switch-wrapper { display:inline-grid; grid-template-columns:1fr 1fr; background:#f5f5f5; padding:4px; border-radius:8px; position:relative; margin-right:10px; }
        .list-switch-wrapper input { display:none; }
        .list-label { padding:6px 16px; cursor:pointer; text-align:center; z-index:2; font-size:14px; font-weight:500; color:#666; transition:color .3s; }
        .list-switch-wrapper input:checked + label { color:#2563eb; }
        .list-slider { position:absolute; top:4px; bottom:4px; left:4px; width:calc(50% - 4px); background:white; border-radius:6px; transition:transform .3s ease; z-index:1; box-shadow:0 1px 2px rgba(0,0,0,.1); }
        #list-programs:checked ~ .list-slider { transform:translateX(100%); }
        
        input[type=file]{ display:none; }
        .person-list { margin-top:0; }
        .sort-header { display:grid; grid-template-columns:150px 150px 120px 1fr; gap:15px; align-items:center; padding:12px 15px; background:#f9fafbbb; backdrop-filter:saturate(180%) blur(8px); border-bottom:1px solid #e6e6e6; font-weight:600; color:#374151; position:sticky; top:125px; z-index:99; }
        .sort-btn { background:none; border:none; cursor:pointer; font-weight:600; font-size:13px; color:#6b7280; display:flex; align-items:center; gap:6px; padding:6px 10px; border-radius:6px; transition:.2s; text-align:left; justify-content:flex-start; }
        .sort-btn:hover { background:#eef2ff; color:#1d4ed8; }
        .sort-btn.active { color:#2563eb; }
        .sort-arrow { font-size:12px; opacity:.5; }
        .sort-btn.active .sort-arrow { opacity:1; }
        .person-item { display:grid; grid-template-columns:150px 150px 120px 1fr; gap:15px; align-items:center; padding:15px; border-bottom:1px solid #e0e0e0; transition:background .2s; }
        .person-item:hover { background:#f9f9f9; }
        .person-id { color:#999; font-size:14px; display:none; }
        .person-firstname,.person-lastname,.person-category { font-size:16px; }
        .person-firstname,.person-lastname { font-weight:500; }
        .person-category { color:#666; font-size:14px; }
        .category-buttons { display:flex; gap:8px; flex-wrap:wrap; }
        .category-btn { padding:8px 16px; border:2px solid; border-radius:5px; cursor:pointer; font-size:14px; font-weight:500; transition:.3s; background:#fff; }
        .category-btn:hover { transform:translateY(-2px); box-shadow:0 2px 4px rgba(0,0,0,.2); }
        .category-btn.selected { color:#fff !important; }
        .category-connect { border-color:#FF5722; color:#FF5722; } .category-connect.selected { background:#FF5722; }
        .category-win { border-color:#2196F3; color:#2196F3; } .category-win.selected { background:#2196F3; }
        .category-build { border-color:#4CAF50; color:#4CAF50; } .category-build.selected { background:#4CAF50; }
        .category-train { border-color:#FF9800; color:#FF9800; } .category-train.selected { background:#FF9800; }
        .category-sendmultiply { border-color:#9C27B0; color:#9C27B0; } .category-sendmultiply.selected { background:#9C27B0; }
        .empty-state { text-align:center; padding:60px 20px; color:#999; }
        .empty-state-icon { font-size:48px; margin-bottom:20px; }
        .chart-container { margin-top:30px; padding:20px; }
        .chart-bars { display:flex; flex-direction:column; gap:20px; margin-top:20px; }
        .chart-bar-wrapper { display:flex; align-items:center; gap:15px; }
        .chart-label { min-width:120px; font-weight:500; font-size:16px; }
        .chart-bar-bg { flex:1; height:40px; background:#e0e0e0; border-radius:5px; overflow:hidden; position:relative; }
        .chart-bar-fill { height:100%; transition:width .5s ease; display:flex; align-items:center; padding-left:10px; color:#fff; font-weight:bold; }
        .chart-count { min-width:40px; text-align:right; font-weight:bold; font-size:18px; }
        @media (max-width:768px){ 
            .sort-header,.person-item{ grid-template-columns:1fr !important; gap:10px; } 
            .sort-header{ top:120px; } 
            .category-btn{ flex:1; min-width:80px; } 
            .chart-grid { grid-template-columns: 1fr !important; }
        }
        /* Dark mode overrides */
        body.dark { background:#0f172a; }
        body.dark .container { background:#111827; box-shadow:0 2px 4px rgba(0,0,0,.5); }
        body.dark .tabs { background:#111827; border-bottom:1px solid #334155; }
        body.dark .tabs-switch-wrapper { background:#0b1220; }
        body.dark .tabs-slider { background:#1f2937; }
        body.dark .tab-label { color:#94a3b8; }
        body.dark .tabs-switch-wrapper input:checked + label { color:#e5e7eb; }
        body.dark .list-switch-wrapper { background:#0b1220; }
        body.dark .list-slider { background:#1f2937; }
        body.dark .list-label { color:#94a3b8; }
        body.dark .list-switch-wrapper input:checked + label { color:#e5e7eb; }
        body.dark .theme-switch-wrapper { background:#0b1220; }
        body.dark .theme-slider { background:#1f2937; }
        body.dark .theme-label { color:#94a3b8; }
        body.dark .theme-switch-wrapper input:checked + label { color:#e5e7eb; }
        body.dark .header { background:#0b1220cc; border-bottom:1px solid #334155; }
        body.dark .header-title { color:#e5e7eb; }
        body.dark .progress-bar { background:#1f2937; }
        body.dark .progress-meta { color:#94a3b8; }
        body.dark .sort-header { background:#0b1220cc; border-bottom:1px solid #334155; color:#cbd5e1; }
        body.dark .sort-btn { color:#94a3b8; }
        body.dark .sort-btn:hover { background:#0f172a; color:#93c5fd; }
        body.dark .sort-btn.active { color:#93c5fd; }
        body.dark .person-item { border-bottom:1px solid #334155; }
        body.dark .person-item:hover { background:#0f172a; }
        body.dark .person-id { color:#94a3b8; }
        body.dark .person-firstname, body.dark .person-lastname, body.dark .person-category { color:#e5e7eb; }
        body.dark .category-btn { background:#0b1220; }
        body.dark .category-btn:hover { box-shadow:0 2px 4px rgba(0,0,0,.6); }
        body.dark .empty-state { color:#9ca3af; }
        body.dark .chart-container h2 { color:#e5e7eb; }
        body.dark .chart-bar-bg { background:#1f2937; }
        body.dark .chart-label { color:#e5e7eb; }
        body.dark .chart-count { color:#e5e7eb; }
        body.dark .csv-note { background:#3b3a1e !important; border-color:#525252 !important; color:#f1f5f9 !important; }

        /* Help tab styles */
        .help-content { max-width:800px; margin:30px auto; padding:0 20px 60px 20px; line-height:1.6; color:#374151; }
        .help-content h2 { margin-bottom:20px; color:#1f2937; }
        .help-content h3 { margin-top:25px; margin-bottom:10px; color:#2563eb; }
        .help-content h3.danger { color:#ef4444; }
        .help-code { background:#f3f4f6; padding:15px; border-radius:6px; margin-top:10px; font-family:monospace; font-size:13px; }
        .help-note { margin-top:10px; font-size:14px; color:#666; }
        .help-disclaimer { font-size:14px; background:#fff5f5; padding:15px; border-left:4px solid #ef4444; border-radius:4px; }

        /* Dark mode help overrides */
        body.dark .help-content { color:#cbd5e1; }
        body.dark .help-content h2 { color:#e5e7eb; }
        body.dark .help-content h3 { color:#93c5fd; }
        body.dark .help-content h3.danger { color:#ef4444; }
        body.dark .help-code { background:#1f2937; color:#e5e7eb; border:1px solid #374151; }
        body.dark .help-note { color:#94a3b8; }
        body.dark .help-disclaimer { background:#450a0a; color:#fca5a5; }
    </style>
</head>
<body>
    <div class="container">
        <div class="tabs">
            <div class="tabs-switch-wrapper">
                <input type="radio" name="tab" id="tab-categorise" value="categorise" checked onchange="switchTab('categorise')">
                <label for="tab-categorise" class="tab-label">Categorise</label>
                <input type="radio" name="tab" id="tab-results" value="results" onchange="switchTab('results')">
                <label for="tab-results" class="tab-label">Results</label>
                <input type="radio" name="tab" id="tab-help" value="help" onchange="switchTab('help')">
                <label for="tab-help" class="tab-label">Help</label>
                <div class="tabs-slider"></div>
            </div>
            <div class="tabs-right">
                <div class="list-switch-wrapper">
                    <input type="radio" name="list-type" id="list-people" value="people" checked onchange="switchList('people')">
                    <label for="list-people" class="list-label">People</label>
                    <input type="radio" name="list-type" id="list-programs" value="programs" onchange="switchList('programs')">
                    <label for="list-programs" class="list-label">Programs</label>
                    <div class="list-slider"></div>
                </div>
                <div class="theme-switch-wrapper">
                    <input type="radio" name="theme" id="theme-light" value="light" checked onchange="toggleTheme(false)">
                    <label for="theme-light" class="theme-label">Light</label>
                    <input type="radio" name="theme" id="theme-dark" value="dark" onchange="toggleTheme(true)">
                    <label for="theme-dark" class="theme-label">Dark</label>
                    <div class="theme-slider"></div>
                </div>
            </div>
        </div>
        <div id="categorise-tab" class="tab-content active">
            <div class="header">
                <div class="header-inner">
                    <div class="header-left">
                        <div class="header-title">Progress</div>
                        <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>
                        <div class="progress-meta"><span id="progress-text"></span></div>
                    </div>
                    <div class="controls">
                        <label for="csv-upload" class="btn btn-primary">Import CSV</label>
                        <input type="file" id="csv-upload" accept=".csv" onchange="handleFileUpload(event)">
                        <button class="btn btn-secondary" onclick="exportData()">Export Data</button>
                        <button class="btn btn-danger" onclick="clearData()">Clear All Data</button>
                    </div>
                </div>
            </div>
            <div id="person-list" class="person-list"></div>
            <div class="csv-note" style="padding:10px 20px; background:#fffbe6; border-top:1px solid #e0e0e0; border-bottom:1px solid #e0e0e0; font-size:13px; color:#5c5c00;">
                <strong>CSV format:</strong> Required headers: <code>ID, Firstname, Lastname</code>. Optional: <code>Category</code>.<br>
                In Programs (Multiple) mode, separate multiple categories with semicolons (e.g., <code>Connect; Build; Train</code>). Only these categories are recognised: <code>Connect</code>, <code>Win</code>, <code>Build</code>, <code>Train</code>, <code>Send/Multiply</code>.
            </div>
        </div>
        <div id="results-tab" class="tab-content">
            <div class="chart-container">
                <h2>Category Distribution</h2>
                <div class="csv-note" style="margin-top:10px; padding:10px 15px; background:#fffbe6; border:1px solid #e0e0e0; font-size:13px; color:#5c5c00; border-radius:4px;">
                    <strong>Comparison:</strong> Showing distribution for both People and Programs.
                </div>
                <div class="chart-grid" style="display:grid; grid-template-columns:1fr 1fr; gap:30px; margin-top:20px;">
                    <div>
                        <h3 style="margin-bottom:15px; color:#666;">People</h3>
                        <div class="chart-bars" id="chart-bars-people">
                            <!-- Bars generated by JS -->
                        </div>
                    </div>
                    <div>
                        <h3 style="margin-bottom:15px; color:#666;">Programs</h3>
                        <div class="chart-bars" id="chart-bars-programs">
                            <!-- Bars generated by JS -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="help-tab" class="tab-content">
            <div class="help-content">
                <h2>Help & Instructions</h2>
                
                <h3>What is this tool?</h3>
                <p>This is a simple tool designed to help you categorise a list of people or programs into the 5 key areas of the Shift m2M framework: <strong>Connect, Win, Build, Train, and Send/Multiply</strong>.</p>

                <h3>1. Setup & Import</h3>
                <p>To get started, you need a CSV file with your data. You can create this in Excel or Google Sheets and save as CSV.</p>
                <ul style="margin-left:20px; margin-top:10px; list-style-type:disc;">
                    <li><strong>Required Headers:</strong> <code>ID</code>, <code>Firstname</code>, <code>Lastname</code></li>
                    <li><strong>Optional Header:</strong> <code>Category</code> (if you already have some data categorised)</li>
                </ul>
                <div class="help-code">
                    ID,Firstname,Lastname,Category<br>
                    101,John,Smith,Win<br>
                    102,Sarah,Jones,<br>
                    P1,Alpha Course,,Connect; Build
                </div>
                <p class="help-note"><em>Note: For programs, put the program name in the Firstname column and leave Lastname blank.</em></p>

                <h3>2. Categorising</h3>
                <p>Use the toggle in the top right to switch between modes:</p>
                <ul style="margin-left:20px; margin-top:10px; list-style-type:disc;">
                    <li><strong>People (Single Mode):</strong> Each person can only belong to one category. Clicking a category button selects it. Clicking a different one moves them. Clicking the selected one again clears it.</li>
                    <li><strong>Programs (Multiple Mode):</strong> Programs can belong to multiple categories (e.g., Connect and Build). Clicking buttons toggles them on and off.</li>
                </ul>

                <h3>3. Save & Export</h3>
                <p>Your progress is <strong>automatically saved</strong> to your browser's local storage, so you can close the tab and come back later (as long as you don't clear your browser cache).</p>
                <ul style="margin-left:20px; margin-top:10px; list-style-type:disc;">
                    <li><strong>Export Data:</strong> Downloads a new CSV file with your updated categorisations.</li>
                    <li><strong>Clear All Data:</strong> Wipes all data from the tool and your browser storage.</li>
                </ul>

                <h3 class="danger">Disclaimer</h3>
                <p class="help-disclaimer">
                    This tool is not affiliated with "Shift m2M", "Power to Change", or any ministry. It is experimental and provided "as is" without warranty. <br><br>
                    <strong>Privacy Notice:</strong> Data is stored ONLY in your local browser (localStorage). No data is sent to any server. However, please do not enter sensitive or personal information beyond basic IDs and names. You are responsible for privacy compliance.
                </p>
            </div>
        </div>
    </div>
    <script>
        const STORAGE_KEY='categorisation-data';
        const MODE_KEY='categorisation-active-list';
        const THEME_KEY='categorisation-theme';
        const CATEGORIES=['Connect','Win','Build','Train','Send/Multiply'];
        let appData = { people: [], programs: [] };
        let sortField='lastname'; let sortDirection='asc'; let activeList='people';
        function applyTheme(theme){const isDark=theme==='dark';document.body.classList.toggle('dark',isDark);if(isDark){document.getElementById('theme-dark').checked=true;}else{document.getElementById('theme-light').checked=true;}}
        function initTheme(){let theme=localStorage.getItem(THEME_KEY);if(!theme){theme=window.matchMedia&&window.matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light';}applyTheme(theme);if(window.matchMedia){window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change',e=>{if(!localStorage.getItem(THEME_KEY)){applyTheme(e.matches?'dark':'light');}});}}
        function toggleTheme(on){const theme=on?'dark':'light';localStorage.setItem(THEME_KEY,theme);applyTheme(theme);}        
        function switchList(listType){activeList=listType;localStorage.setItem(MODE_KEY,listType);renderPeopleList();updateProgress();}
        function loadFromStorage(){
            const stored = localStorage.getItem(STORAGE_KEY);
            const storedMode = localStorage.getItem(MODE_KEY);
            if(storedMode){
                activeList = storedMode;
                document.querySelector(`input[name="list-type"][value="${storedMode}"]`).checked=true;
            }
            if(stored){
                try{
                    const parsedData = JSON.parse(stored);
                    // Handle migration from old array format if necessary
                    if(Array.isArray(parsedData)){
                        appData.people = [];
                        appData.programs = [];
                    } else {
                        appData.people = parsedData.people || [];
                        appData.programs = parsedData.programs || [];
                    }
                } catch(e) {
                    console.error('Error loading data:',e);
                    appData = { people: [], programs: [] };
                }
            }
            renderPeopleList();
            updateProgress();
            updateChart();
        }
        function saveToStorage(){localStorage.setItem(STORAGE_KEY,JSON.stringify(appData));}
        function handleFileUpload(ev){const file=ev.target.files[0];if(!file)return;const r=new FileReader();r.onload=e=>parseCSV(e.target.result);r.readAsText(file);ev.target.value='';}
        function parseCSV(text){
            text=text.replace(/^\uFEFF/, '');
            const lines=text.split(/\r\n|\n|\r/).filter(l=>l.trim());
            if(lines.length<2){alert('CSV file must contain headers and at least one data row');return;}
            const headers=lines[0].split(',').map(h=>h.trim().toLowerCase());
            const idIndex=headers.indexOf('id');
            const fnIndex=headers.indexOf('firstname');
            const lnIndex=headers.indexOf('lastname');
            const catIndex=headers.indexOf('category');
            
            if(activeList === 'people' && (idIndex===-1||fnIndex===-1||lnIndex===-1)){
                alert('CSV for People must contain headers: ID, Firstname, Lastname');return;
            }
            if(activeList === 'programs' && (idIndex===-1||fnIndex===-1)){
                alert('CSV for Programs must contain headers: ID, Firstname (use for Program Name)');return;
            }

            const newList=[];
            for(let i=1;i<lines.length;i++){
                const vals=lines[i].split(',').map(v=>v.trim());
                if(vals.length>=2){ // At least ID and Name
                    const item={
                        id:vals[idIndex]||'',
                        firstname:vals[fnIndex]||'',
                        lastname:activeList==='people'?(vals[lnIndex]||''):'',
                        category:activeList==='programs'?[]:null
                    };
                    if(catIndex!==-1&&vals.length>catIndex){
                        const raw=vals[catIndex];
                        if(raw){
                            const parsed=raw.split(';').map(v=>v.trim()).filter(Boolean);
                            if(activeList==='programs'){
                                item.category=parsed.filter(c=>CATEGORIES.includes(c));
                            }else{
                                item.category=parsed.find(c=>CATEGORIES.includes(c))||null;
                            }
                        }
                    }
                    newList.push(item);
                }
            }
            appData[activeList] = newList;
            saveToStorage();
            renderPeopleList();
            updateProgress();
            updateChart();
        }
        function sortPeopleData(){
            const list = appData[activeList];
            const sorted=[...list];
            sorted.sort((a,b)=>{
                let aVal,bVal;
                if(sortField==='id'){
                    aVal=parseInt(a.id)||0;bVal=parseInt(b.id)||0;
                }else if(sortField==='category'){
                    const order=['Connect','Win','Build','Train','Send/Multiply'];
                    if(Array.isArray(a.category)){aVal=a.category.length>0?order.indexOf(a.category[0]):999;}else{aVal=a.category?order.indexOf(a.category):999;}
                    if(Array.isArray(b.category)){bVal=b.category.length>0?order.indexOf(b.category[0]):999;}else{bVal=b.category?order.indexOf(b.category):999;}
                }else{
                    aVal=(a[sortField]||'').toLowerCase();bVal=(b[sortField]||'').toLowerCase();
                }
                if(aVal<bVal)return sortDirection==='asc'?-1:1; 
                if(aVal>bVal)return sortDirection==='asc'?1:-1; 
                return 0;
            });
            return sorted;
        }
        function toggleSort(f){if(sortField===f){sortDirection=sortDirection==='asc'?'desc':'asc';}else{sortField=f;sortDirection='asc';}renderPeopleList();}
        function renderPeopleList(){
            const el=document.getElementById('person-list');
            const list = appData[activeList];
            if(list.length===0){
                el.innerHTML=`<div class="empty-state"><div class="empty-state-icon">ðŸ“‹</div><h3>No ${activeList} loaded</h3><p>Import a CSV file to get started</p></div>`;
                return;
            }
            const sorted=sortPeopleData();
            const arrow=sortDirection==='asc'?'â†‘':'â†“';
            
            let headerHTML = '';
            if(activeList === 'people'){
                headerHTML = `<div class="sort-header">
                    <button class="sort-btn ${sortField==='firstname'?'active':''}" onclick="toggleSort('firstname')">First Name <span class="sort-arrow">${sortField==='firstname'?arrow:'â†•'}</span></button>
                    <button class="sort-btn ${sortField==='lastname'?'active':''}" onclick="toggleSort('lastname')">Last Name <span class="sort-arrow">${sortField==='lastname'?arrow:'â†•'}</span></button>
                    <button class="sort-btn ${sortField==='category'?'active':''}" onclick="toggleSort('category')">Category <span class="sort-arrow">${sortField==='category'?arrow:'â†•'}</span></button>
                    <div></div>
                </div>`;
            } else {
                headerHTML = `<div class="sort-header" style="grid-template-columns:1fr 120px 1fr;">
                    <button class="sort-btn ${sortField==='firstname'?'active':''}" onclick="toggleSort('firstname')">Program Name <span class="sort-arrow">${sortField==='firstname'?arrow:'â†•'}</span></button>
                    <button class="sort-btn ${sortField==='category'?'active':''}" onclick="toggleSort('category')">Category <span class="sort-arrow">${sortField==='category'?arrow:'â†•'}</span></button>
                    <div></div>
                </div>`;
            }

            el.innerHTML= headerHTML + sorted.map(p=>{
                const idx=list.indexOf(p);
                let rowHTML = '';
                if(activeList === 'people'){
                    rowHTML = `<div class="person-item">
                        <div class="person-firstname" title="ID: ${p.id}">${p.firstname}</div>
                        <div class="person-lastname" title="ID: ${p.id}">${p.lastname}</div>
                        <div class="person-category">${p.category||'-'}</div>
                        <div class="category-buttons">${CATEGORIES.map(cat=>{
                            const sel=p.category===cat;
                            return `<button class="category-btn category-${cat.toLowerCase().replace('/','')} ${sel?'selected':''}" onclick="setCategory(${idx},'${cat}')">${cat}</button>`
                        }).join('')}</div>
                    </div>`;
                } else {
                    rowHTML = `<div class="person-item" style="grid-template-columns:1fr 120px 1fr;">
                        <div class="person-firstname" title="ID: ${p.id}">${p.firstname}</div>
                        <div class="person-category">${Array.isArray(p.category)?(p.category.length>0?p.category.join(', '):'-'):'-'}</div>
                        <div class="category-buttons">${CATEGORIES.map(cat=>{
                            const sel=Array.isArray(p.category)?p.category.includes(cat):false;
                            return `<button class="category-btn category-${cat.toLowerCase().replace('/','')} ${sel?'selected':''}" onclick="setCategory(${idx},'${cat}')">${cat}</button>`
                        }).join('')}</div>
                    </div>`;
                }
                return rowHTML;
            }).join('');
        }
        function setCategory(i,cat){
            const list = appData[activeList];
            if(activeList==='programs'){
                if(!Array.isArray(list[i].category)) list[i].category=[];
                const pos=list[i].category.indexOf(cat);
                if(pos>-1){list[i].category.splice(pos,1);}else{list[i].category.push(cat);}
            }else{
                if(list[i].category===cat){list[i].category=null;}else{list[i].category=cat;}
            }
            saveToStorage();
            renderPeopleList();
            updateProgress();
            updateChart();
        }
        function updateProgress(){
            const list = appData[activeList];
            const categorised=list.filter(p=>Array.isArray(p.category)?p.category.length>0:p.category!==null).length;
            const total=list.length;
            const pct=total>0?(categorised/total)*100:0;
            document.getElementById('progress-fill').style.width=pct+'%';
            document.getElementById('progress-text').textContent=`${categorised} / ${total} (${Math.round(pct)}%)`;
        }
        function updateChart(){
            const renderChart = (list, containerId) => {
                const counts={'Connect':0,'Win':0,'Build':0,'Train':0,'Send/Multiply':0};
                list.forEach(p=>{
                    if(Array.isArray(p.category)){
                        p.category.forEach(c=>{if(counts[c]!==undefined)counts[c]++;});
                    }else if(p.category&&counts[p.category]!==undefined){
                        counts[p.category]++;
                    }
                });
                const max=Math.max(...Object.values(counts),1);
                const colors={'Connect':'#FF5722','Win':'#2196F3','Build':'#4CAF50','Train':'#FF9800','Send/Multiply':'#9C27B0'};
                const html = Object.keys(counts).map(cat=>{
                    const pct=(counts[cat]/max)*100;
                    return `<div class="chart-bar-wrapper">
                        <div class="chart-label">${cat}</div>
                        <div class="chart-bar-bg"><div class="chart-bar-fill" style="background:${colors[cat]};width:${pct}%;"></div></div>
                        <div class="chart-count">${counts[cat]}</div>
                    </div>`;
                }).join('');
                const container = document.getElementById(containerId);
                if(container) container.innerHTML = html;
            };
            renderChart(appData.people, 'chart-bars-people');
            renderChart(appData.programs, 'chart-bars-programs');
        }
        function switchTab(name){
            document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
            document.getElementById(name+'-tab').classList.add('active');
            const listSwitch = document.querySelector('.list-switch-wrapper');
            if(listSwitch) listSwitch.style.display = name === 'categorise' ? 'inline-grid' : 'none';
            if(name==='results')updateChart();
        }
        function clearData(){
            if(confirm(`Are you sure you want to clear all ${activeList} data? This cannot be undone.`)){
                appData[activeList]=[];
                saveToStorage();
                renderPeopleList();
                updateProgress();
                updateChart();
            }
        }
        function exportData(){
            const list = appData[activeList];
            if(list.length===0){alert('No data to export');return;}
            let csv='ID,Firstname,Lastname,Category\n';
            list.forEach(p=>{
                const cStr=Array.isArray(p.category)?p.category.join('; '):(p.category||'');
                csv+=`${p.id},${p.firstname},${p.lastname},${cStr}\n`;
            });
            const blob=new Blob([csv],{type:'text/csv'});
            const url=URL.createObjectURL(blob);
            const a=document.createElement('a');
            a.href=url;
            a.download=`categorised-${activeList}-`+new Date().toISOString().split('T')[0]+'.csv';
            a.click();
            URL.revokeObjectURL(url);
        }
        initTheme();loadFromStorage();
    </script>
</body>
</html>